name: Tag Release â†’ Play Store

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write        

jobs:
  deploy:
    runs-on: ubuntu-latest

    # â”€â”€â”€â”€â”€â”€â”€ APP SPECIFIC CONFIG (ONLY EDIT THIS) â”€â”€â”€â”€â”€â”€â”€
    env:
      PACKAGE_NAME: com.example.test_app     # ðŸ‘ˆ CHANGE PER APP
      VERSION_CODE_OFFSET: 1                # ðŸ‘ˆ YOUR CURRENT PLAY VERSION
      PLAY_TRACK: alpha                    # internal | alpha ( closed testing) | beta (open testing) | production
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml
          cache: true


  
      # â”€â”€â”€â”€â”€ VERSION HANDLING â”€â”€â”€â”€â”€
      - name: Set version from tag with offset
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          VERSION_CODE=$((${{ github.run_number }} + $VERSION_CODE_OFFSET))
          sed -i "s/^version:.*/version: $VERSION+$VERSION_CODE/" pubspec.yaml

      - run: flutter pub get
      - run: flutter build appbundle --release

      # â”€â”€â”€â”€â”€ ONLY MAJOR/MINOR â†’ GITHUB RELEASE â”€â”€â”€â”€â”€
      - name: Check major/minor
        id: check
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.0$ ]]; then
            echo "major_minor=true" >> $GITHUB_OUTPUT
          else
            echo "major_minor=false" >> $GITHUB_OUTPUT
          fi

      # - name: Create GitHub Release (AAB only)
      #   if: steps.check.outputs.major_minor == 'true'
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     files: build/app/outputs/bundle/release/app-release.aab
      #     name: ${{ github.ref_name }}
      #     body: |
      #       Android AAB Release  
      #       Package: ${{ env.PACKAGE_NAME }}
      #       Version: ${{ github.ref_name }}
      #       Track: ${{ env.PLAY_TRACK }}


      - name: Create GitHub Release (AAB only)
        if: steps.check.outputs.major_minor == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/bundle/release/app-release.aab
          name: ${{ github.ref_name }}
          body: |
            Android AAB Release  
            Package: ${{ env.PACKAGE_NAME }}
            Version: ${{ github.ref_name }}
            Track: ${{ env.PLAY_TRACK }}
